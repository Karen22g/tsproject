
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Modelos de redes neuronales &#8212; Proyecto final</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'nn';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Modelo mejorado para pronóstico de serie de tiempo" href="improved_model.html" />
    <link rel="prev" title="Modelos autorregresivo integrado de media móvil" href="arima.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Proyecto final</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Proyecto Final - Series de Tiempo 202430
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="data_prep.html">Análisis cualitativo y preparación de la base de datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="eda.html">Análisis exploratorio de la Serie de Tiempo</a></li>
<li class="toctree-l1"><a class="reference internal" href="smoothing.html">Modelos de Suavización Exponencial</a></li>
<li class="toctree-l1"><a class="reference internal" href="arima.html">Modelos autorregresivo integrado de media móvil</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Modelos de redes neuronales</a></li>
<li class="toctree-l1"><a class="reference internal" href="improved_model.html">Modelo mejorado para pronóstico de serie de tiempo</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fnn.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/nn.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Modelos de redes neuronales</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#funciones-complementarias">1. Funciones complementarias</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-de-la-funcion-de-activacion">2. Selección de la función de activación</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-modelo-con-uso-de-funcion-tanh">2.1 Test modelo con uso de función ‘tanh’</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-modelo-con-uso-de-funcion-relu">2.2 Test modelo con uso de función ‘relu’</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks-rnn">3. Recurrent neural networks (RNN)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multilayer-perceptron-mlp">4. Multilayer Perceptron (MLP)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#long-short-term-memory-lstm">5. Long Short Term Memory (LSTM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-del-mejor-modelo">6. Selección del mejor modelo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-resultados">7. Análisis de resultados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entrenamiento-modelos-y-parametros">7.1 Entrenamiento: Modelos y Parámetros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#top-15-mejores-mae-en-el-conjunto-de-testing">7.2 Top 15 mejores MAE en el conjunto de testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pronostico-con-el-mejor-modelo">7.3 Pronóstico con el mejor modelo</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Dropout</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">dump</span><span class="p">,</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.tsaplots</span> <span class="kn">import</span> <span class="n">plot_acf</span><span class="p">,</span> <span class="n">plot_pacf</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">LSTM</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.diagnostic</span> <span class="kn">import</span> <span class="n">acorr_ljungbox</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.stattools</span> <span class="kn">import</span> <span class="n">jarque_bera</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.losses</span> <span class="kn">import</span> <span class="n">MeanSquaredError</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">SimpleRNN</span><span class="p">,</span> <span class="n">Dropout</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="modelos-de-redes-neuronales">
<h1>Modelos de redes neuronales<a class="headerlink" href="#modelos-de-redes-neuronales" title="Link to this heading">#</a></h1>
<p>Apliquemos a continuación Modelos de Redes Neuronales a nuestra serie de tiempo, para conocer el comportamiento del pronóstico que se puede alcanzar a partir de estos. En este apartado estaremos aplicando:</p>
<ol class="arabic simple">
<li><p>Recurrent neural networks</p></li>
<li><p>Multilayer-perceptron</p></li>
<li><p>Long-short term memory</p></li>
</ol>
<p>Durante el análisis se estarán construyendo modelos para distintas combinaciones de épocas, input layers, neuronas y tasas de drop-out.</p>
<p>Cada una de los apartados a continuación incluyen funciones de creación de la red neuronal, además se diseñó una función que retorna el mejor modelo en cada caso, para automatizar la creación y selección para cada combinación. Carguemos los datos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;loadsts.xlsx&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Posted_date&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="s1">&#39;D&#39;</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Loads&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>En el caso de red neuronales, escalaremos los datos con el fin de disminuir el tiempo de alcance de la convergencia.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;loads_escaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Loads&#39;</span><span class="p">]</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">ts_esc</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;loads_escaler&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<section id="funciones-complementarias">
<h2>1. Funciones complementarias<a class="headerlink" href="#funciones-complementarias" title="Link to this heading">#</a></h2>
<p>Al igual que en los otros capítulos estaremos usando las funciones de apoyo para separación de la serie, evaluación de supuestos y evaluación de los ‘score’ de pronóstico.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">serie</span><span class="p">,</span> <span class="n">trainportion</span><span class="p">):</span>
    <span class="n">perct</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">*</span> <span class="n">trainportion</span><span class="p">)</span>
    <span class="n">perc2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trainportion</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">serie</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">perct</span><span class="p">]</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="n">serie</span><span class="p">[</span><span class="n">perct</span><span class="p">:</span><span class="n">perct</span><span class="o">+</span><span class="n">perc2</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">serie</span><span class="p">[</span><span class="n">perct</span><span class="o">+</span><span class="n">perc2</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">validation</span><span class="p">,</span> <span class="n">test</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#calculo de los errores</span>
<span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_real</span><span class="p">):</span>
    
    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_real</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">mape</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(((</span><span class="n">y_real</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">/</span><span class="n">y_real</span><span class="p">)))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_real</span><span class="p">))</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_real</span> <span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_real</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mae</span><span class="p">,</span> <span class="n">mape</span><span class="p">,</span> <span class="n">mse</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">r2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#evaluacion de supuestos</span>
<span class="k">def</span> <span class="nf">assumptions</span><span class="p">(</span><span class="n">residuals</span><span class="p">):</span>

    <span class="n">warning</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1">#Independency</span>
    <span class="c1">#H0: The residuals are independent.</span>
    <span class="c1">#H1: The residuals aren&#39;t independent.    </span>
    <span class="n">ljung_box_test</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ljung_box_pvalue</span> <span class="o">=</span> <span class="n">ljung_box_test</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ljung_box_pvalue</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">warning</span><span class="o">=</span> <span class="n">warning</span> <span class="o">+</span> <span class="s2">&quot; The residuals aren&#39;t independent&quot;</span>
        <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1">#Normality test</span>
    <span class="c1">#H0: The residuals have a normal distribution.</span>
    <span class="c1">#H1: The residuals don&#39;t have a normal distribution.</span>
    <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pvalue</span><span class="p">,</span> <span class="n">skewness</span><span class="p">,</span> <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">jarque_bera</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jb_pvalue</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">warning</span> <span class="o">=</span> <span class="n">warning</span> <span class="o">+</span> <span class="s2">&quot; The residuals do not follow a normal distribution&quot;</span>

    <span class="c1">#homocedasticity</span>
    <span class="c1">#H0: The residuals are homocedastic.</span>
    <span class="c1">#H1: The residuals aren&#39;t homocedastic.</span>
    <span class="n">arch_stat</span><span class="p">,</span> <span class="n">arch_pvalue</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">het_arch</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arch_pvalue</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">warning</span><span class="o">=</span> <span class="n">warning</span> <span class="o">+</span> <span class="s2">&quot; The residuals aren&#39;t homocedastic&quot;</span>
        <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">arch_pvalue</span><span class="p">,</span> <span class="n">jb_pvalue</span><span class="p">,</span> <span class="n">ljung_box_pvalue</span><span class="p">,</span> <span class="n">warning</span>
</pre></div>
</div>
</div>
</div>
<p>A continuación la función con que pronosticaremos los valores de validación y testing para el cálculo de los errores y desempeño del modelo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#forecast</span>
<span class="k">def</span> <span class="nf">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_val</span><span class="p">):</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">preds</span>
</pre></div>
</div>
</div>
</div>
<p>Además, agregaremos la función <em>makeXy</em> que se encarga de organizar la serie de tiempo en un arreglo matricial que genera el input layer de <span class="math notranslate nohighlight">\(nbtimesteps\)</span> y la predicción <span class="math notranslate nohighlight">\(y\)</span> de un valor a la vez. Durante la selección del mejor modelo de cada tipo de red neuronal estaremos probando esta división para los valores de 3, 4, 5 días para entrenar la red.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">makeXy</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">nbtimesteps</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbtimesteps</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">nbtimesteps</span><span class="p">:</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">#Regressors</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1">#Target</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<p>El conjunto de entrenamiento tendrá el 80% datos en este entrenamiento de red neuronal. Guardaremos los conjuntos con los valores reales y los valores escalados a continuación:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">train_esc</span><span class="p">,</span> <span class="n">val_esc</span><span class="p">,</span> <span class="n">test_esc</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">ts_esc</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Entrenamiento&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validación&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prueba&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Conjuntos de Entrenamiento, Validación y Prueba&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fecha&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cargas de Transportadas Diarias&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fd4134e7e836df75ed7c0c84a361b28ce26249a38e551d75d376f5b6fa8e27a7.png" src="_images/fd4134e7e836df75ed7c0c84a361b28ce26249a38e551d75d376f5b6fa8e27a7.png" />
</div>
</div>
</section>
<section id="seleccion-de-la-funcion-de-activacion">
<h2>2. Selección de la función de activación<a class="headerlink" href="#seleccion-de-la-funcion-de-activacion" title="Link to this heading">#</a></h2>
<p>La función de activación a través de la red neuronal juega un papel crítico en el cálculo de los pesos de cada capa. Existen distintas funciones de activación como ‘tanh’, ‘relu’, ‘sigmoid’, entre otras. A continuación haremos una prueba rápida comparando el desempeño de la red neuronal cuando usamos ‘tanh’ y cuando usamos ‘relu’, para conocer cuál mejora el desempeño de las métricas de error.</p>
<p>Dividamos además el conjunto de training, validación y test para esta prueba.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">train_esc</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">val_esc</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_trainr</span><span class="p">,</span> <span class="n">y_trainr</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_valr</span><span class="p">,</span> <span class="n">y_valr</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="test-modelo-con-uso-de-funcion-tanh">
<h3>2.1 Test modelo con uso de función ‘tanh’<a class="headerlink" href="#test-modelo-con-uso-de-funcion-tanh" title="Link to this heading">#</a></h3>
<p>En este paso estamos generando el modelo de red neuronal Multilayer Perceptron (MLP) para un input de 3 datos, 100 neuronas y una tasa de drop-out de 0.2, estos mismos parámetros los utilizaremos cuando creamos la red neuronal con ‘relu’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">dense1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
<span class="n">dropout_layer</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">dense1</span><span class="p">)</span>
<span class="n">output_layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">dropout_layer</span><span class="p">)</span>

<span class="n">modeltanh</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_layer</span><span class="p">)</span>
<span class="n">modeltanh</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>En el siguiente paso guardamos en una carpeta los distintos modelos generados en las épocas revisadas, en este caso solo 10. De estos modelos seleccionaremos el que mejor ‘val_loss’ tenga, es decir el que mejor pronóstico de la validación alcanzó.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_weights_at</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;keras_models&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">modeltanh</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_weights_batch</span><span class="si">{</span><span class="mi">16</span><span class="si">}</span><span class="s1">_</span><span class="se">{{</span><span class="s1">epoch:02d</span><span class="se">}}</span><span class="s1">-</span><span class="se">{{</span><span class="s1">val_loss:.4f</span><span class="se">}}</span><span class="s1">.keras&#39;</span><span class="p">)</span>
<span class="n">save_best</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">save_weights_at</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">save_freq</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">);</span>

<span class="n">history_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;historynn&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;history_</span><span class="si">{</span><span class="n">modeltanh</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_batch</span><span class="si">{</span><span class="mi">16</span><span class="si">}</span><span class="s1">.joblib&#39;</span><span class="p">)</span>
<span class="n">history_airp</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_filename</span><span class="p">):</span>
    <span class="n">history_filename</span> <span class="o">=</span> <span class="n">history_filename</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;El archivo &#39;</span><span class="si">{history_filename}</span><span class="s2">&#39; ya existe. Se ha cargado el historial del entrenamiento.&quot;</span><span class="p">)</span>
        
<span class="k">else</span><span class="p">:</span>
    <span class="n">history_airp</span> <span class="o">=</span> <span class="n">modeltanh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">save_best</span><span class="p">],</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
                             <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">dump</span><span class="p">(</span><span class="n">history_airp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">history_filename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;El entrenamiento se ha completado y el historial ha sido guardado en &#39;</span><span class="si">{history_filename}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El archivo &#39;{history_filename}&#39; ya existe. Se ha cargado el historial del entrenamiento.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_dir</span> <span class="o">=</span> <span class="s1">&#39;keras_models&#39;</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">modeltanh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">_weights_batch</span><span class="si">{</span><span class="mi">16</span><span class="si">}</span><span class="s2">_(\d+)-([\d\.]+)\.keras&quot;</span>
    
<span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="n">best_model_file</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
    
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
            <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
            <span class="n">best_model_file</span> <span class="o">=</span> <span class="n">file</span>
    
<span class="k">if</span> <span class="n">best_model_file</span><span class="p">:</span>
    <span class="n">best_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">best_model_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cargando el mejor modelo: </span><span class="si">{</span><span class="n">best_model_file</span><span class="si">}</span><span class="s2"> con val_loss: </span><span class="si">{</span><span class="n">best_val_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">best_model_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No se encontraron archivos de modelos que coincidan con el patrón.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cargando el mejor modelo: functional_weights_batch16_02-0.0700.keras con val_loss: 0.07
</pre></div>
</div>
</div>
</div>
<p>Con el mejor modelo seleccionado por el comando anterior podemos hacer una predicción rápida del conjunto de test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
<span class="n">errors</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_valr</span><span class="p">)</span> <span class="c1">#mae, mape, mse, rmse, r2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 95ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 5ms/step 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(19.97561721801758,
 inf,
 459.37336925783615,
 21.4329972065933,
 -0.06413447856903076)
</pre></div>
</div>
</div>
</div>
<p>Podemos observar que el MAE obtenido con el mejor modelo calculado a partir de la función ‘tanh’ es 21 unidades. Mucho más que lo que se ha alcanzado con los modelos de suavización exponencial de primer orden incluso.</p>
</section>
<section id="test-modelo-con-uso-de-funcion-relu">
<h3>2.2 Test modelo con uso de función ‘relu’<a class="headerlink" href="#test-modelo-con-uso-de-funcion-relu" title="Link to this heading">#</a></h3>
<p>Hagamos el mismo procedimiento ahora para modelos calculados con la función de activación ‘relu’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">dense1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
<span class="n">dropout_layer</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">dense1</span><span class="p">)</span>
<span class="n">output_layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">dropout_layer</span><span class="p">)</span>

<span class="n">modelrelu</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_layer</span><span class="p">)</span>
<span class="n">modelrelu</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_weights_at</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;keras_models&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">modelrelu</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_weights_batch</span><span class="si">{</span><span class="mi">16</span><span class="si">}</span><span class="s1">_</span><span class="se">{{</span><span class="s1">epoch:02d</span><span class="se">}}</span><span class="s1">-</span><span class="se">{{</span><span class="s1">val_loss:.4f</span><span class="se">}}</span><span class="s1">.keras&#39;</span><span class="p">)</span>
<span class="n">save_best</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">save_weights_at</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">save_freq</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">);</span>

<span class="n">history_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;historynn&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;history_</span><span class="si">{</span><span class="n">modelrelu</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_batch</span><span class="si">{</span><span class="mi">16</span><span class="si">}</span><span class="s1">.joblib&#39;</span><span class="p">)</span>
<span class="n">history_airp</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_filename</span><span class="p">):</span>
    <span class="n">history_filename</span> <span class="o">=</span> <span class="n">history_filename</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;El archivo &#39;</span><span class="si">{history_filename}</span><span class="s2">&#39; ya existe. Se ha cargado el historial del entrenamiento.&quot;</span><span class="p">)</span>
        
<span class="k">else</span><span class="p">:</span>
    <span class="n">history_airp</span> <span class="o">=</span> <span class="n">modelrelu</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">save_best</span><span class="p">],</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
                             <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">dump</span><span class="p">(</span><span class="n">history_airp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">history_filename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;El entrenamiento se ha completado y el historial ha sido guardado en &#39;</span><span class="si">{history_filename}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El archivo &#39;{history_filename}&#39; ya existe. Se ha cargado el historial del entrenamiento.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_dir</span> <span class="o">=</span> <span class="s1">&#39;keras_models&#39;</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">modelrelu</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">_weights_batch</span><span class="si">{</span><span class="mi">16</span><span class="si">}</span><span class="s2">_(\d+)-([\d\.]+)\.keras&quot;</span>
    
<span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="n">best_model_file</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
    
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
            <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
            <span class="n">best_model_file</span> <span class="o">=</span> <span class="n">file</span>
    
<span class="k">if</span> <span class="n">best_model_file</span><span class="p">:</span>
    <span class="n">best_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">best_model_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cargando el mejor modelo: </span><span class="si">{</span><span class="n">best_model_file</span><span class="si">}</span><span class="s2"> con val_loss: </span><span class="si">{</span><span class="n">best_val_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">best_model_path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No se encontraron archivos de modelos que coincidan con el patrón.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cargando el mejor modelo: functional_1_weights_batch16_10-0.0478.keras con val_loss: 0.0478
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
<span class="n">errors</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_valr</span><span class="p">)</span> <span class="c1">#mae, mape, mse, rmse, r2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 116ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 26ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 26ms/step
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(13.517213470458984,
 inf,
 313.54557260470557,
 17.707218093328652,
 0.27367424964904785)
</pre></div>
</div>
</div>
</div>
<p>Como podemos observar el MAE para los mismos parámetros utilizados tiene 6.5 unidades menos que cuando se usa la función ‘tanh’. Por lo que estaremos usando la función ‘relu’ en la creación de nuestras funciones de redes neuronales.</p>
</section>
</section>
<section id="recurrent-neural-networks-rnn">
<h2>3. Recurrent neural networks (RNN)<a class="headerlink" href="#recurrent-neural-networks-rnn" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_RNN</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span> <span class="c1">#Creación RNN</span>
    <span class="n">model_RNN</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model_RNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">SimpleRNN</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="n">model_RNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">))</span>
    <span class="n">model_RNN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
    <span class="n">model_RNN</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model_RNN</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="multilayer-perceptron-mlp">
<h2>4. Multilayer Perceptron (MLP)<a class="headerlink" href="#multilayer-perceptron-mlp" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_mlp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">neurons</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span>
    
    <span class="n">input_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">dense1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">neurons</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
    <span class="n">dropout_layer</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">dense1</span><span class="p">)</span>
    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">dropout_layer</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_layer</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="long-short-term-memory-lstm">
<h2>5. Long Short Term Memory (LSTM)<a class="headerlink" href="#long-short-term-memory-lstm" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_lstm</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">neurons</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span>

    <span class="n">input_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">lstm_layer</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">neurons</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
    <span class="n">dropout_layer</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">lstm_layer</span><span class="p">)</span>
    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">dropout_layer</span><span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_layer</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="seleccion-del-mejor-modelo">
<h2>6. Selección del mejor modelo<a class="headerlink" href="#seleccion-del-mejor-modelo" title="Link to this heading">#</a></h2>
<p>Con la función de activación seleccionada, las funciones de las redes neuronales y conocidos los parámetros que queremos ir combinando de neuronas, drop_out y épocas podemos iniciar el proceso de selección del mejor modelo.</p>
<p>Para ello fijamos esta primera función <em>select_model</em> con la que guardamos los historiales de procesamiento de modelos en cada época y con la que al final capturamos el mejor modelo generado para esa combinación de parámetros.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>

    <span class="n">save_weights_at</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;keras_models&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="se">{{</span><span class="s1">epoch:02d</span><span class="se">}}</span><span class="s1">-</span><span class="se">{{</span><span class="s1">val_loss:.4f</span><span class="se">}}</span><span class="s1">.keras&#39;</span><span class="p">)</span>
    <span class="n">save_best</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">save_weights_at</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">save_freq</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">);</span>
    
    <span class="n">history_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;historynn&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;history_</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.joblib&#39;</span><span class="p">)</span>
    <span class="n">history_airp</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_filename</span><span class="p">):</span>
        <span class="n">history_filename</span> <span class="o">=</span> <span class="n">history_filename</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;El archivo &#39;</span><span class="si">{history_filename}</span><span class="s2">&#39; ya existe. Se ha cargado el historial del entrenamiento.&quot;</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">history_airp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">ep</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">save_best</span><span class="p">],</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
                 <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
        
        <span class="n">dump</span><span class="p">(</span><span class="n">history_airp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">history_filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;El entrenamiento se ha completado y el historial ha sido guardado en &#39;</span><span class="si">{history_filename}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">model_dir</span> <span class="o">=</span> <span class="s1">&#39;keras_models&#39;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">_(\d+)-([\d\.]+)\.keras&quot;</span>
    
    <span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">best_model_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
                <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
                <span class="n">best_model_file</span> <span class="o">=</span> <span class="n">file</span>

    <span class="k">if</span> <span class="n">best_model_file</span><span class="p">:</span>
        <span class="n">best_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">best_model_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cargando el mejor modelo: </span><span class="si">{</span><span class="n">best_model_file</span><span class="si">}</span><span class="s2"> con val_loss: </span><span class="si">{</span><span class="n">best_val_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">best_model_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No se encontraron archivos de modelos que coincidan con el patrón.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">best_model</span>
</pre></div>
</div>
</div>
</div>
<p>En este ciclo a continuación, fijamos todas las combinaciones de parámetros que deseamos testear, las agregamos a un ciclo que recibe y procesa de acuerdo a cada red neuronal planteada la combinación de parámetros, selecciona el mejor modelo haciendo llamado a la función <em>select_model</em> y al final pronostica tanto validación como testing. Además los score de pronóstico para cada conjunto los calcula y los guarda.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="c1">#Probamos inputs de 3 y 4 datos</span>
<span class="n">neurons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="n">ep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">]</span>
<span class="n">drop_out</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]</span>
<span class="n">val_result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">test_result</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
    
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">train_esc</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">val_esc</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">test_esc</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">X_valr</span><span class="p">,</span> <span class="n">y_valr</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_testr</span><span class="p">,</span> <span class="n">y_testr</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">neurons</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">eph</span> <span class="ow">in</span> <span class="n">ep</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dpout</span> <span class="ow">in</span> <span class="n">drop_out</span><span class="p">:</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Esta combinación es&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">dpout</span><span class="p">)</span>
                
                <span class="c1">#creación modelo RNN</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">create_RNN</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dpout</span><span class="p">)</span>
                <span class="n">best_model</span> <span class="o">=</span> <span class="n">select_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>

                <span class="c1">#validacion</span>
                <span class="n">val_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_val</span><span class="p">)</span> <span class="c1">#pronosticar validacion</span>
                <span class="n">mae_v</span><span class="p">,</span> <span class="n">mape_v</span><span class="p">,</span> <span class="n">mse_v</span><span class="p">,</span> <span class="n">rmse_v</span><span class="p">,</span> <span class="n">r2_v</span> <span class="o">=</span> <span class="n">errors</span><span class="p">(</span><span class="n">val_pred</span><span class="p">,</span> <span class="n">y_valr</span><span class="p">)</span> <span class="c1">#scores validación</span>

                <span class="c1">#testing</span>
                <span class="n">test_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span> <span class="c1">#pronosticar test</span>
                <span class="n">mae_t</span><span class="p">,</span> <span class="n">mape_t</span><span class="p">,</span> <span class="n">mse_t</span><span class="p">,</span> <span class="n">rmse_t</span><span class="p">,</span> <span class="n">r2_t</span> <span class="o">=</span> <span class="n">errors</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">y_testr</span><span class="p">)</span> <span class="c1">#scores testing</span>
                
                <span class="n">val_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;rnn&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">dpout</span><span class="p">,</span> <span class="n">mape_v</span><span class="p">,</span> <span class="n">mae_v</span><span class="p">,</span> <span class="n">mse_v</span><span class="p">,</span> <span class="n">rmse_v</span><span class="p">,</span> <span class="n">r2_v</span><span class="p">])</span>
                <span class="n">test_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;rnn&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">dpout</span><span class="p">,</span> <span class="n">mape_t</span><span class="p">,</span> <span class="n">mae_t</span><span class="p">,</span> <span class="n">mse_t</span><span class="p">,</span> <span class="n">rmse_t</span><span class="p">,</span> <span class="n">r2_t</span><span class="p">])</span>

                <span class="c1">#creación modelo MLP</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">create_mlp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dpout</span><span class="p">)</span>
                <span class="n">best_model</span> <span class="o">=</span> <span class="n">select_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>

                <span class="c1">#validacion</span>
                <span class="n">val_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_val</span><span class="p">)</span> <span class="c1">#pronosticar validacion</span>
                <span class="n">mae_v</span><span class="p">,</span> <span class="n">mape_v</span><span class="p">,</span> <span class="n">mse_v</span><span class="p">,</span> <span class="n">rmse_v</span><span class="p">,</span> <span class="n">r2_v</span> <span class="o">=</span> <span class="n">errors</span><span class="p">(</span><span class="n">val_pred</span><span class="p">,</span> <span class="n">y_valr</span><span class="p">)</span> <span class="c1">#scores validación</span>

                <span class="c1">#testing</span>
                <span class="n">test_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span> <span class="c1">#pronosticar test</span>
                <span class="n">mae_t</span><span class="p">,</span> <span class="n">mape_t</span><span class="p">,</span> <span class="n">mse_t</span><span class="p">,</span> <span class="n">rmse_t</span><span class="p">,</span> <span class="n">r2_t</span> <span class="o">=</span> <span class="n">errors</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">y_testr</span><span class="p">)</span> <span class="c1">#scores testing</span>
                
                <span class="n">val_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;mlp&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">dpout</span><span class="p">,</span> <span class="n">mape_v</span><span class="p">,</span> <span class="n">mae_v</span><span class="p">,</span> <span class="n">mse_v</span><span class="p">,</span> <span class="n">rmse_v</span><span class="p">,</span> <span class="n">r2_v</span><span class="p">])</span>
                <span class="n">test_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;mlp&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">dpout</span><span class="p">,</span> <span class="n">mape_t</span><span class="p">,</span> <span class="n">mae_t</span><span class="p">,</span> <span class="n">mse_t</span><span class="p">,</span> <span class="n">rmse_t</span><span class="p">,</span> <span class="n">r2_t</span><span class="p">])</span>

                <span class="c1">#creación modelo LSTM</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">create_lstm</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dpout</span><span class="p">)</span>
                <span class="n">best_model</span> <span class="o">=</span> <span class="n">select_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>

                <span class="c1">#validacion</span>
                <span class="n">val_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_val</span><span class="p">)</span> <span class="c1">#pronosticar validacion</span>
                <span class="n">mae_v</span><span class="p">,</span> <span class="n">mape_v</span><span class="p">,</span> <span class="n">mse_v</span><span class="p">,</span> <span class="n">rmse_v</span><span class="p">,</span> <span class="n">r2_v</span> <span class="o">=</span> <span class="n">errors</span><span class="p">(</span><span class="n">val_pred</span><span class="p">,</span> <span class="n">y_valr</span><span class="p">)</span> <span class="c1">#scores validación</span>

                <span class="c1">#testing</span>
                <span class="n">test_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span> <span class="c1">#pronosticar test</span>
                <span class="n">mae_t</span><span class="p">,</span> <span class="n">mape_t</span><span class="p">,</span> <span class="n">mse_t</span><span class="p">,</span> <span class="n">rmse_t</span><span class="p">,</span> <span class="n">r2_t</span> <span class="o">=</span> <span class="n">errors</span><span class="p">(</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">y_testr</span><span class="p">)</span> <span class="c1">#scores testing</span>
                
                <span class="n">val_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;lstm&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">dpout</span><span class="p">,</span> <span class="n">mape_v</span><span class="p">,</span> <span class="n">mae_v</span><span class="p">,</span> <span class="n">mse_v</span><span class="p">,</span> <span class="n">rmse_v</span><span class="p">,</span> <span class="n">r2_v</span><span class="p">])</span>
                <span class="n">test_result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;lstm&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">dpout</span><span class="p">,</span> <span class="n">mape_t</span><span class="p">,</span> <span class="n">mae_t</span><span class="p">,</span> <span class="n">mse_t</span><span class="p">,</span> <span class="n">rmse_t</span><span class="p">,</span> <span class="n">r2_t</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Esta combinación es 3 100 10 0.2
El archivo &#39;{history_filename}&#39; ya existe. Se ha cargado el historial del entrenamiento.
Cargando el mejor modelo: sequential_05-0.0303.keras con val_loss: 0.0303
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 9 calls to &lt;function TensorFlowTrainer.make_predict_function.&lt;locals&gt;.one_step_on_data_distributed at 0x000002669CE01990&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 345ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:6 out of the last 12 calls to &lt;function TensorFlowTrainer.make_predict_function.&lt;locals&gt;.one_step_on_data_distributed at 0x000002669CE01990&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 102ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 102ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 59ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 10ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El archivo &#39;{history_filename}&#39; ya existe. Se ha cargado el historial del entrenamiento.
Cargando el mejor modelo: functional_8_09-0.0468.keras con val_loss: 0.0468
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 163ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 24ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 25ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 50ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 5ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El archivo &#39;{history_filename}&#39; ya existe. Se ha cargado el historial del entrenamiento.
Cargando el mejor modelo: functional_9_05-0.0745.keras con val_loss: 0.0745
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 486ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 127ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 129ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 41ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 14ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Esta combinación es 3 100 10 0.4
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El archivo &#39;{history_filename}&#39; ya existe. Se ha cargado el historial del entrenamiento.
Cargando el mejor modelo: sequential_1_10-0.0287.keras con val_loss: 0.0287
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 336ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 101ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 102ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 50ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 5ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El archivo &#39;{history_filename}&#39; ya existe. Se ha cargado el historial del entrenamiento.
Cargando el mejor modelo: functional_16_06-0.0485.keras con val_loss: 0.0485
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 116ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 24ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 27ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 49ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 3ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 4s - 64ms/step - loss: 0.0534 - val_loss: 0.0819
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 2/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 12ms/step - loss: 0.0427 - val_loss: 0.0766
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 3/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 8ms/step - loss: 0.0421 - val_loss: 0.0723
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 4/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 9ms/step - loss: 0.0414 - val_loss: 0.0807
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 5/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 6ms/step - loss: 0.0415 - val_loss: 0.0738
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 6/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 10ms/step - loss: 0.0403 - val_loss: 0.0728
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 7/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 10ms/step - loss: 0.0407 - val_loss: 0.0773
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 8/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 7ms/step - loss: 0.0408 - val_loss: 0.0784
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 9/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 11ms/step - loss: 0.0403 - val_loss: 0.0667
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 10/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 10ms/step - loss: 0.0409 - val_loss: 0.0765
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El entrenamiento se ha completado y el historial ha sido guardado en &#39;{history_filename}&#39;
Cargando el mejor modelo: functional_17_09-0.0667.keras con val_loss: 0.0667
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 306ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 100ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 100ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 47ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 6ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Esta combinación es 3 100 10 0.6
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 3s - 50ms/step - loss: 0.0589 - val_loss: 0.0750
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 2/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0395 - val_loss: 0.0553
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 3/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0365 - val_loss: 0.0578
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 4/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0337 - val_loss: 0.0514
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 5/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 1s - 10ms/step - loss: 0.0306 - val_loss: 0.0489
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 6/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0296 - val_loss: 0.0529
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 7/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0297 - val_loss: 0.0526
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 8/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0282 - val_loss: 0.0468
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 9/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 4ms/step - loss: 0.0289 - val_loss: 0.0504
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 10/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 6ms/step - loss: 0.0272 - val_loss: 0.0486
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El entrenamiento se ha completado y el historial ha sido guardado en &#39;{history_filename}&#39;
Cargando el mejor modelo: sequential_2_08-0.0468.keras con val_loss: 0.0468
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 269ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 84ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 84ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">1/4</span> <span class=" -Color -Color-Green">━━━━━</span><span class=" -Color -Color-White">━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 47ms/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 5ms/step 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 2s - 33ms/step - loss: 0.0635 - val_loss: 0.0834
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 2/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 6ms/step - loss: 0.0434 - val_loss: 0.0698
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 3/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0386 - val_loss: 0.0634
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 4/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 6ms/step - loss: 0.0364 - val_loss: 0.0586
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 5/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 5ms/step - loss: 0.0336 - val_loss: 0.0565
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 6/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 4ms/step - loss: 0.0314 - val_loss: 0.0541
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 7/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 3ms/step - loss: 0.0314 - val_loss: 0.0542
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 8/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 4ms/step - loss: 0.0311 - val_loss: 0.0538
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 9/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 4ms/step - loss: 0.0289 - val_loss: 0.0561
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 10/10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>65/65 - 0s - 6ms/step - loss: 0.0275 - val_loss: 0.0514
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>El entrenamiento se ha completado y el historial ha sido guardado en &#39;{history_filename}&#39;
Cargando el mejor modelo: functional_24_10-0.0514.keras con val_loss: 0.0514
</pre></div>
</div>
</div>
</div>
<p>Son 36 combinaciones de parámetros cada una evaluada para 3 modelos de redes neuronales, hemos generado 108 modelos y es momento de analizar el desempeño de cada uno de estos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">val_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>108
</pre></div>
</div>
</div>
</div>
<p>Exportaremos estos resultados para guardarlos junto a los demás resultados de los otros modelos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfval</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">val_result</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;neurons&#39;</span><span class="p">,</span> <span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="s1">&#39;mape&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="s1">&#39;rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">])</span>
<span class="n">dftest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_result</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;neurons&#39;</span><span class="p">,</span> <span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="s1">&#39;mape&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="s1">&#39;rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">])</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dftest</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">&quot;results/nwtest.xlsx&quot;</span><span class="p">)</span>
<span class="n">dfval</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">&quot;results/nwval.xlsx&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="analisis-de-resultados">
<h2>7. Análisis de resultados<a class="headerlink" href="#analisis-de-resultados" title="Link to this heading">#</a></h2>
<p>Analicemos a continuación el comportamiento del MAE con respecto a los parámetros y modelo utilizado. Así como el desempeño de las redes neuronales durante el testing.</p>
<section id="entrenamiento-modelos-y-parametros">
<h3>7.1 Entrenamiento: Modelos y Parámetros<a class="headerlink" href="#entrenamiento-modelos-y-parametros" title="Link to this heading">#</a></h3>
<p>Observemos la distribución del MAE para los 3 tipos de redes neuronales analizados.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfval</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución del MAE por Tipo de Modelo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tipo de Modelo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e34d546d09923bbf53c378729a80888dab2f666fccdd24e2d95ce77d9a5ad2e6.png" src="_images/e34d546d09923bbf53c378729a80888dab2f666fccdd24e2d95ce77d9a5ad2e6.png" />
</div>
</div>
<p><strong>Key insights</strong></p>
<ol class="arabic simple">
<li><p>El modelo LSTM presentó el mayor MAE registrado en las corridas del algoritmo, de hecho en el 50% de los casos tiene 16 unidades de MAE o más, esto es menor que lo alcanzado incluso con el modelo ARIMA del capítulo anterior y la suavización exponencial simple. Importante considerar que en los parámetros de la LSTM no utilizamos la función de activación RELU que sí consideramos para el modelo MLP y RNN.</p></li>
<li><p>El primer puesto lo ocupó la red neuronal RNN, que alcanzó el valor mínimo entre los 3 modelos, de hecho su valor máximo está todavía por debajo del modelo MLP. En el 50% de los casos tiene aproximadamente menos de 12 unidades de MAE, la mejor mediana entre los 3 modelos.</p></li>
</ol>
<p>Ahora con respecto a los parámetros utilizados dentro del modelo, podemos observar lo siguiente:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mae_neurons</span> <span class="o">=</span> <span class="n">dfval</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;neurons&#39;</span><span class="p">)[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">mae_dropout</span> <span class="o">=</span> <span class="n">dfval</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">)[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">mae_epochs</span> <span class="o">=</span> <span class="n">dfval</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;epochs&#39;</span><span class="p">)[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">mae_neurons</span><span class="p">[</span><span class="s1">&#39;neurons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">mae_neurons</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MAE Promedio por Número de Neuronas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Número de Neuronas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE Promedio&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">mae_dropout</span><span class="p">[</span><span class="s1">&#39;dropout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">mae_dropout</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MAE Promedio por Dropout&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Dropout&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE Promedio&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">mae_epochs</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">mae_epochs</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MAE Promedio por Número de Épocas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Número de Épocas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE Promedio&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7755bb1cedbd4b4ef0fc74304b4f35a70fb526562ecbe31e5ce9c3724846f371.png" src="_images/7755bb1cedbd4b4ef0fc74304b4f35a70fb526562ecbe31e5ce9c3724846f371.png" />
</div>
</div>
<p><strong>Key insights</strong></p>
<ol class="arabic simple">
<li><p>Con respecto a las neuronas, se observa que a medida que se incrementó el valor se consiguió un mejor MAE, sin embargo la diferencia es mínimo entre 500 y 1000 neuronas, para optimizar el código se pueden dejar solo 500 y se reducen el número de combinaciones para evaluar.</p></li>
<li><p>Con respecto al dropout observamos que a medida que aumentamos la tasa, aumenta el MAE, podríamos buscar probar una tasa de 0.1 en evaluaciones posteriores para conocer si esto mejora el desempeño del modelo.</p></li>
<li><p>Con respecto al número de épocas el desempeñó sí presentó una alta variación, de hecho cuando se usaron 25 épocas el MAE disminuó casi 2 unidades en promedio, por lo que quisiéramos probar en otra ocasión un número de épocas mayor y conocer si eso mejora el desempeño.</p></li>
</ol>
</section>
<section id="top-15-mejores-mae-en-el-conjunto-de-testing">
<h3>7.2 Top 15 mejores MAE en el conjunto de testing<a class="headerlink" href="#top-15-mejores-mae-en-el-conjunto-de-testing" title="Link to this heading">#</a></h3>
<p>Analicemos ahora los modelos que alcanzaron el mejor MAE en el testing, sus pronósticos y el tipo de modelo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dftest</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución del MAE por Tipo de Modelo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tipo de Modelo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/00e9a36e344a2b38a5683ce7b86a24a48d40047bf2c1946da33a97fe5f19fc3c.png" src="_images/00e9a36e344a2b38a5683ce7b86a24a48d40047bf2c1946da33a97fe5f19fc3c.png" />
</div>
</div>
<p><strong>Key insights</strong></p>
<ol class="arabic simple">
<li><p>En el test se mantuvo el mismo podio, sin embargo la red LSTM mejoró su resultado MAE promedio.</p></li>
<li><p>La RNN emparejó más sus resultados con la red MLP, sin embargo obtuvo de nuevo el menor valor MAE registrado. En el 50% de los conjuntos de test que pronosticó, de hecho, obtuvo un valor cercano a 10 unidades, mientras que la MLP un valor por encima de 11.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dftest</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;mae&quot;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model</th>
      <th>neurons</th>
      <th>epochs</th>
      <th>dropout</th>
      <th>mape</th>
      <th>mae</th>
      <th>mse</th>
      <th>rmse</th>
      <th>r2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>69</th>
      <td>rnn</td>
      <td>100</td>
      <td>25</td>
      <td>0.6</td>
      <td>inf</td>
      <td>7.464502</td>
      <td>113.344922</td>
      <td>10.646357</td>
      <td>0.683541</td>
    </tr>
    <tr>
      <th>91</th>
      <td>mlp</td>
      <td>1000</td>
      <td>10</td>
      <td>0.2</td>
      <td>inf</td>
      <td>7.573771</td>
      <td>112.843935</td>
      <td>10.622803</td>
      <td>0.684940</td>
    </tr>
    <tr>
      <th>75</th>
      <td>rnn</td>
      <td>500</td>
      <td>10</td>
      <td>0.4</td>
      <td>inf</td>
      <td>7.791840</td>
      <td>126.241094</td>
      <td>11.235706</td>
      <td>0.647535</td>
    </tr>
    <tr>
      <th>96</th>
      <td>rnn</td>
      <td>1000</td>
      <td>10</td>
      <td>0.6</td>
      <td>inf</td>
      <td>7.800657</td>
      <td>123.804271</td>
      <td>11.126737</td>
      <td>0.654339</td>
    </tr>
    <tr>
      <th>84</th>
      <td>rnn</td>
      <td>500</td>
      <td>25</td>
      <td>0.4</td>
      <td>inf</td>
      <td>7.845781</td>
      <td>128.819801</td>
      <td>11.349881</td>
      <td>0.640336</td>
    </tr>
    <tr>
      <th>76</th>
      <td>mlp</td>
      <td>500</td>
      <td>10</td>
      <td>0.4</td>
      <td>inf</td>
      <td>7.956229</td>
      <td>121.193801</td>
      <td>11.008806</td>
      <td>0.661627</td>
    </tr>
    <tr>
      <th>54</th>
      <td>rnn</td>
      <td>100</td>
      <td>10</td>
      <td>0.2</td>
      <td>inf</td>
      <td>7.956674</td>
      <td>129.640784</td>
      <td>11.385991</td>
      <td>0.638043</td>
    </tr>
    <tr>
      <th>78</th>
      <td>rnn</td>
      <td>500</td>
      <td>10</td>
      <td>0.6</td>
      <td>inf</td>
      <td>8.029625</td>
      <td>125.188040</td>
      <td>11.188746</td>
      <td>0.650476</td>
    </tr>
    <tr>
      <th>63</th>
      <td>rnn</td>
      <td>100</td>
      <td>25</td>
      <td>0.2</td>
      <td>inf</td>
      <td>8.034240</td>
      <td>134.584676</td>
      <td>11.601064</td>
      <td>0.624240</td>
    </tr>
    <tr>
      <th>79</th>
      <td>mlp</td>
      <td>500</td>
      <td>10</td>
      <td>0.6</td>
      <td>inf</td>
      <td>8.057249</td>
      <td>123.130328</td>
      <td>11.096411</td>
      <td>0.656221</td>
    </tr>
    <tr>
      <th>99</th>
      <td>rnn</td>
      <td>1000</td>
      <td>25</td>
      <td>0.2</td>
      <td>inf</td>
      <td>8.063574</td>
      <td>137.441519</td>
      <td>11.723545</td>
      <td>0.616264</td>
    </tr>
    <tr>
      <th>97</th>
      <td>mlp</td>
      <td>1000</td>
      <td>10</td>
      <td>0.6</td>
      <td>inf</td>
      <td>8.105024</td>
      <td>124.115713</td>
      <td>11.140723</td>
      <td>0.653469</td>
    </tr>
    <tr>
      <th>73</th>
      <td>mlp</td>
      <td>500</td>
      <td>10</td>
      <td>0.2</td>
      <td>inf</td>
      <td>8.115881</td>
      <td>124.646327</td>
      <td>11.164512</td>
      <td>0.651988</td>
    </tr>
    <tr>
      <th>66</th>
      <td>rnn</td>
      <td>100</td>
      <td>25</td>
      <td>0.4</td>
      <td>inf</td>
      <td>8.126293</td>
      <td>134.891361</td>
      <td>11.614274</td>
      <td>0.623384</td>
    </tr>
    <tr>
      <th>81</th>
      <td>rnn</td>
      <td>500</td>
      <td>25</td>
      <td>0.2</td>
      <td>inf</td>
      <td>8.130408</td>
      <td>139.624596</td>
      <td>11.816285</td>
      <td>0.610169</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Key insights Top 15</strong></p>
<ol class="arabic simple">
<li><p>El mejor MAE fue de 7.46 unidades con el modelo RNN, casi un 50% menos que el conseguido con ARIMA en el capítulo anterior. Además aumentó el R2 a 68% ante 23% que presentó ARIMA.</p></li>
<li><p>En segundo lugar se alcanzó un MAE de 7.57 unidades, en este caso con el modelo MLP, que de hecho presenta un mejor R2 que la serie RNN, es decir logró capturar un poco mejor la variabilidad de la respuesta.</p></li>
<li><p>Ahora si observamos el top 15 de mejores modelos, podemos observar que no hay ningún caso en el que se encuentre el modelo LSTM. De hecho el 66% de los modelos que están en este top fueron calculados a partir de RNN.</p></li>
<li><p>Curiosamente mejor modelo tiene parámetros 100 neuronas, 25 épocas y 0.6 de drop-out, lo que no coincide con el análisis del entrenamiento, en donde 100 neuronas y 0.6 de drop-out estaba relacionado con los menores MAE.</p></li>
<li><p>En esta tabla no se observa, pero <strong>la partición mejoró cuando se usaban 4 datos como input layer</strong>.</p></li>
</ol>
</section>
<section id="pronostico-con-el-mejor-modelo">
<h3>7.3 Pronóstico con el mejor modelo<a class="headerlink" href="#pronostico-con-el-mejor-modelo" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">train_esc</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">val_esc</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">test_esc</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
<span class="n">X_valr</span><span class="p">,</span> <span class="n">y_valr</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_testr</span><span class="p">,</span> <span class="n">y_testr</span> <span class="o">=</span> <span class="n">makeXy</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">create_RNN</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">select_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eph</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>

<span class="n">val_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_val</span><span class="p">)</span>
<span class="n">test_pred</span> <span class="o">=</span> <span class="n">forecast_nw</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/25
65/65 - 2s - 25ms/step - loss: 0.0494 - val_loss: 0.0498
Epoch 2/25
65/65 - 0s - 6ms/step - loss: 0.0283 - val_loss: 0.0447
Epoch 3/25
65/65 - 0s - 6ms/step - loss: 0.0249 - val_loss: 0.0330
Epoch 4/25
65/65 - 0s - 5ms/step - loss: 0.0212 - val_loss: 0.0360
Epoch 5/25
65/65 - 0s - 5ms/step - loss: 0.0199 - val_loss: 0.0339
Epoch 6/25
65/65 - 0s - 6ms/step - loss: 0.0190 - val_loss: 0.0317
Epoch 7/25
65/65 - 0s - 6ms/step - loss: 0.0189 - val_loss: 0.0290
Epoch 8/25
65/65 - 0s - 5ms/step - loss: 0.0175 - val_loss: 0.0310
Epoch 9/25
65/65 - 0s - 5ms/step - loss: 0.0180 - val_loss: 0.0306
Epoch 10/25
65/65 - 0s - 5ms/step - loss: 0.0165 - val_loss: 0.0303
Epoch 11/25
65/65 - 0s - 5ms/step - loss: 0.0164 - val_loss: 0.0304
Epoch 12/25
65/65 - 0s - 5ms/step - loss: 0.0157 - val_loss: 0.0313
Epoch 13/25
65/65 - 0s - 6ms/step - loss: 0.0153 - val_loss: 0.0310
Epoch 14/25
65/65 - 0s - 5ms/step - loss: 0.0159 - val_loss: 0.0295
Epoch 15/25
65/65 - 0s - 6ms/step - loss: 0.0154 - val_loss: 0.0284
Epoch 16/25
65/65 - 0s - 4ms/step - loss: 0.0155 - val_loss: 0.0301
Epoch 17/25
65/65 - 0s - 5ms/step - loss: 0.0148 - val_loss: 0.0300
Epoch 18/25
65/65 - 0s - 5ms/step - loss: 0.0145 - val_loss: 0.0302
Epoch 19/25
65/65 - 0s - 6ms/step - loss: 0.0142 - val_loss: 0.0320
Epoch 20/25
65/65 - 0s - 5ms/step - loss: 0.0150 - val_loss: 0.0302
Epoch 21/25
65/65 - 0s - 5ms/step - loss: 0.0147 - val_loss: 0.0300
Epoch 22/25
65/65 - 0s - 5ms/step - loss: 0.0140 - val_loss: 0.0304
Epoch 23/25
65/65 - 0s - 6ms/step - loss: 0.0161 - val_loss: 0.0294
Epoch 24/25
65/65 - 0s - 5ms/step - loss: 0.0141 - val_loss: 0.0286
Epoch 25/25
65/65 - 0s - 4ms/step - loss: 0.0156 - val_loss: 0.0301
El entrenamiento se ha completado y el historial ha sido guardado en &#39;{history_filename}&#39;
Cargando el mejor modelo: sequential_38_15-0.0284.keras con val_loss: 0.0284
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 43ms/step
<span class=" -Color -Color-Bold">4/4</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 4ms/step 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y_testr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cargas diarias transportadas&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pronóstico Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparación de Pronóstico y test con RNN&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fecha&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cargas transportadas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/041cc965b54cc174e04231fcbea003b689fef30205445e471bca60e75e8a81f8.png" src="_images/041cc965b54cc174e04231fcbea003b689fef30205445e471bca60e75e8a81f8.png" />
</div>
</div>
<p>Se observa un mucho mejor ajuste que el anteriormente obtenido usando modelos de tipo ARIMA y suavización exponencial.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="arima.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Modelos autorregresivo integrado de media móvil</p>
      </div>
    </a>
    <a class="right-next"
       href="improved_model.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Modelo mejorado para pronóstico de serie de tiempo</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#funciones-complementarias">1. Funciones complementarias</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-de-la-funcion-de-activacion">2. Selección de la función de activación</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-modelo-con-uso-de-funcion-tanh">2.1 Test modelo con uso de función ‘tanh’</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-modelo-con-uso-de-funcion-relu">2.2 Test modelo con uso de función ‘relu’</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks-rnn">3. Recurrent neural networks (RNN)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multilayer-perceptron-mlp">4. Multilayer Perceptron (MLP)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#long-short-term-memory-lstm">5. Long Short Term Memory (LSTM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-del-mejor-modelo">6. Selección del mejor modelo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-resultados">7. Análisis de resultados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entrenamiento-modelos-y-parametros">7.1 Entrenamiento: Modelos y Parámetros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#top-15-mejores-mae-en-el-conjunto-de-testing">7.2 Top 15 mejores MAE en el conjunto de testing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pronostico-con-el-mejor-modelo">7.3 Pronóstico con el mejor modelo</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Karen Gomez
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>